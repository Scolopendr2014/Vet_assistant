# Известные баги

Список заведённых багов и их статус. ID артефактов — сквозная нумерация, реестр: [ARTIFACTS.md](ARTIFACTS.md).

**Статусы:** *открыт* — баг воспроизводится; *исправлен* — в код внесено исправление; *закрыто* — исправление подтверждено (пересборка/тесты, баг не воспроизводится).

---

<a id="vet-001"></a>

## VET-001 — В PDF не отображаются русские символы

**ID артефакта:** VET-001  
**Статус:** исправлен  
**Дата:** 2026-02-04  
**Модуль:** `lib/features/pdf/` — генерация PDF протокола

### Описание

В сгенерированных PDF-файлах протоколов русский текст не отображается (или отображается как пустые места/квадраты). Затрагиваются все русскоязычные строки: заголовки («Протокол осмотра», «Анамнез», «Данные осмотра», «Фотографии»), данные пациента, анамнез, извлечённые поля, подписи к фото, футер с нумерацией страниц.

### Причина

Пакет `pdf` (Dart) по умолчанию использует встроенные PDF-шрифты (например, Helvetica), которые не содержат глифов кириллицы. В коде добавлена загрузка шрифтов Roboto из `assets/fonts/` или по URL, но в сборке шрифты не подключаются: в каталоге `assets/fonts/` нет файлов `Roboto-Regular.ttf` и `Roboto-Bold.ttf`, а загрузка из сети может не срабатывать (нет доступа, таймаут, блокировка). В результате `_pdfFontRegular` остаётся `null` и используется шрифт по умолчанию без кириллицы.

### Где воспроизвести

- `lib/features/pdf/services/protocol_pdf_service.dart` — все вызовы `pw.Text(...)` с русским текстом.
- Действия: создать протокол с русскими данными → сформировать PDF → открыть PDF в просмотрщике.

### Варианты решения

1. **Рекомендуется:** Скачать шрифты Roboto (кириллица) и положить в проект: `Roboto-Regular.ttf` и `Roboto-Bold.ttf` в каталог `assets/fonts/`. Ссылки для скачивания — в `assets/fonts/README.md`. После добавления файлов выполнить `flutter pub get` и пересобрать приложение.
2. Убедиться, что в `pubspec.yaml` в секции `flutter.assets` перечислены эти файлы (или каталог `assets/fonts/`), чтобы они попадали в сборку.
3. Для отладки: временно не глотать исключения в `_loadPdfFonts()` (убрать пустой `catch (_)`), чтобы видеть ошибку загрузки из assets или из сети.

### Связанные файлы

- `lib/features/pdf/services/protocol_pdf_service.dart`
- `pubspec.yaml` (зависимость `pdf`, секция `assets`)
- `assets/fonts/` (должны присутствовать `Roboto-Regular.ttf`, `Roboto-Bold.ttf`)

### Исправление

Шрифты Roboto с кириллицей подключены: загрузка из `assets/fonts/Roboto-Regular.ttf` и `Roboto-Bold.ttf`, при отсутствии — подгрузка по URL (GitHub, jsDelivr) с таймаутом. Во всех `pw.TextStyle` в `ProtocolPdfService` передаётся шрифт; русский текст в PDF отображается корректно.

---

<a id="vet-037"></a>

## VET-037 — В админке по кнопке «Выход» не всегда попадаешь в список пациентов

**ID артефакта:** VET-037  
**Статус:** закрыто  
**Дата:** 2026-02-04  
**Модуль:** `lib/features/admin/` — панель администратора

### Описание

После нажатия кнопки «Выход» (иконка logout) в панели администратора пользователь не всегда попадает на экран списка пациентов. Ожидается переход на главный экран со списком пациентов; наблюдается переход на страницу входа в админку (`/admin/login`) или нестабильное поведение.

### Где воспроизвести

- `lib/features/admin/presentation/pages/admin_dashboard_page.dart` — кнопка «Выйти» в AppBar (стр. ~38–41), обработчик: `context.go('/admin/login')`.
- Действия: войти в админку → нажать «Выход» → проверить, на какой экран произошёл переход.

### Варианты решения

1. Заменить переход на маршрут списка пациентов (например, `context.go('/')` или соответствующий путь из роутера) вместо `/admin/login`, чтобы после выхода пользователь оказывался на списке пациентов.
2. Проверить конфигурацию go_router (редиректы, начальный маршрут) и убедиться, что при выходе стек навигации сбрасывается и открывается экран списка пациентов.

### Связанные файлы

- `lib/features/admin/presentation/pages/admin_dashboard_page.dart`
- Конфигурация роутера (go_router)

### Исправление

Переход при нажатии «Выход» изменён с `context.go('/admin/login')` на `context.go('/patients')` — пользователь попадает на список пациентов.

---

<a id="vet-038"></a>

## VET-038 — После добавления протокола не обновляется список протоколов у пациента на экране

**ID артефакта:** VET-038  
**Статус:** закрыто  
**Дата:** 2026-02-04  
**Модуль:** `lib/features/examinations/`, `lib/features/patients/` — создание протокола и карточка пациента

### Описание

После успешного сохранения нового протокола осмотра приложение переходит на экран карточки пациента (`/patients/{id}`), но список протоколов (история осмотров) на этом экране не обновляется — новый протокол не отображается до перезахода на экран или перезапуска приложения. Ожидается: после сохранения протокола список осмотров у пациента сразу содержит новый протокол.

### Причина

Список осмотров берётся из провайдера `examinationsByPatientProvider(patientId)` (Riverpod). После вызова `context.go('/patients/${widget.patientId}')` экран карточки пациента отображает закэшированный результат провайдера; инвалидация кэша после сохранения протокола не выполняется.

### Где воспроизвести

- Создание протокола: `lib/features/examinations/presentation/pages/examination_create_page.dart` — после `repo.save(examination)` выполняется `context.go('/patients/${widget.patientId}')` без инвалидации провайдера списка осмотров.
- Отображение списка: `lib/features/patients/presentation/pages/patient_detail_page.dart` — используется `ref.watch(examinationsByPatientProvider(patientId))`.
- Действия: открыть карточку пациента → «Новый протокол» → заполнить и сохранить → на экране карточки пациента новый протокол не появляется в списке.

### Варианты решения

1. После сохранения протокола в `examination_create_page.dart` перед переходом инвалидировать провайдер: `ref.invalidate(examinationsByPatientProvider(widget.patientId!))`, затем `context.go(...)`.
2. Использовать общий провайдер-инвалидатор (например, `examinationsInvalidatorProvider`) и вызывать его при save/delete осмотра, чтобы все экраны, зависящие от списка осмотров по пациенту, получили актуальные данные.

### Связанные файлы

- `lib/features/examinations/presentation/pages/examination_create_page.dart`
- `lib/features/patients/presentation/pages/patient_detail_page.dart`
- `lib/features/examinations/presentation/providers/examination_providers.dart` (`examinationsByPatientProvider`)

---

<a id="vet-039"></a>

## VET-039 — Экспорт JSON в админке: непонятно, как сохранить или отправить JSON

**ID артефакта:** VET-039  
**Статус:** закрыто  
**Дата:** 2026-02-05  
**Модуль:** `lib/features/admin/`, экспорт (JSON) — админ-панель

### Описание

При нажатии на «Экспорт JSON» в админке появляется сообщение: «JSON готов (3042 символов). Сохраните через копирование или экспорт в файл.» Пользователю неочевидно, что нужно сделать дальше, чтобы сохранить или отправить JSON: нет явных кнопок «Копировать» / «Экспорт в файл» или пошаговой подсказки. В результате непонятно, как выполнить копирование или экспорт в файл.

### Где воспроизвести

- Админ-панель → кнопка/действие «Экспорт JSON» → диалог/снэкбар с текстом про сохранение через копирование или экспорт в файл.
- Действия: войти в админку → нажать «Экспорт JSON» → прочитать сообщение и попытаться сохранить/отправить JSON.

### Варианты решения

1. Добавить в диалог/экран с результатом экспорта явные кнопки: «Копировать в буфер» и «Сохранить в файл» (через file_picker / share_plus или аналог), чтобы действие было однозначным.
2. Если кнопки уже есть — улучшить текст сообщения и визуальное выделение кнопок (например: «JSON готов. Нажмите «Копировать» или «Сохранить в файл» ниже.»).
3. Для «Сохранить в файл»: вызвать диалог выбора пути/имени файла и записать JSON в выбранный файл; для копирования — `Clipboard.setData(ClipboardData(text: jsonString))`.

### Связанные файлы

- Код админки с экспортом JSON (админ-дашборд, экспорт-сервис, диалоги).
- При необходимости: `lib/features/export/` — сервисы экспорта.

### Исправление

Вместо SnackBar при выборе «Экспорт JSON» показывается диалог «Экспорт JSON» с текстом «JSON готов (N символов). Выберите действие:» и тремя кнопками: «Закрыть», «Копировать» (копирует JSON в буфер обмена и показывает SnackBar «Скопировано в буфер обмена»), «Сохранить в файл» (записывает JSON во временный файл и открывает системный шаринг — пользователь может сохранить файл или отправить). Файл: `lib/features/admin/presentation/pages/admin_dashboard_page.dart`.

---

<a id="vet-054"></a>

## VET-054 — flutter analyze: синтаксическая ошибка в examination_create_page

**ID артефакта:** VET-054  
**Статус:** исправлен  
**Дата:** 2026-02-05  
**Модуль:** `lib/features/examinations/presentation/pages/examination_create_page.dart`

### Описание

При запуске `flutter analyze` в методе `_buildForm` в конце виджета `Column` возникали ошибки разбора:
- Expected to find ';' (expected_token) на строках 378–379
- Dead code, missing_identifier, unexpected_token
- Unnecessary empty statement (empty_statements)

Причина: в конце возвращаемого выражения `return Column( ... );` была лишняя закрывающая скобка и запятая: использовалось `      ),` и `    );` вместо одного `      );`, из‑за чего парсер воспринимал конструкцию неверно.

### Где воспроизвести

- `lib/features/examinations/presentation/pages/examination_create_page.dart`, метод `_buildForm`, строки ~377–380 (закрытие `Column` и `return`).
- Действия: выполнить `flutter analyze`.

### Исправление

Исправлено закрытие метода `_buildForm`: убрана лишняя пара `),` и `);` — оставлено одно закрытие `      );` для `Column` и завершения `return`, затем `  }` для закрытия метода.

---

<a id="vet-040"></a>
## VET-040 — ReferenceRepositoryImpl / DI, пути, Drift orderBy

**Статус:** исправлен  
**Модуль:** references, di_container

Ошибки: argument_type_not_assignable (DI); implements_non_class, override_on_non_overriding_member, invocation_of_non_function_expression, static_access_to_instance_member, dead_null_aware в reference_repository_impl (неверный путь к ReferenceRepository, неверный вызов OrderingTerm).

**Исправление:** Путь к app_database в domain — `../../../core/database/app_database.dart`. В impl: корректный импорт интерфейса, сортировка через `OrderingTerm.asc(r.orderIndex)`.

---

<a id="vet-041"></a>
## VET-041 — Отсутствует native_speech_service.dart, использование NativeSpeechService

**Статус:** исправлен  
**Модуль:** examination_create_page

Импорт `native_speech_service.dart` и класс NativeSpeechService отсутствуют; страница создания протокола ссылается на них (диктовка в реальном времени).

**Исправление:** Удалены импорт, поле _nativeSpeech, флаги _isDictating/_dictationBase и логика диктовки; оставлены запись аудио и кнопка «Распознать» (STT по файлу).

---

<a id="vet-042"></a>
## VET-042 — Неверный URI app_config в stt_router.dart

**Статус:** исправлен  
**Модуль:** speech/domain/services/stt_router.dart

Target of URI doesn't exist: `../../../core/config/app_config.dart` (относительный путь от domain/services неверен).

**Исправление:** Заменён на `../../../../core/config/app_config.dart` (четыре уровня вверх до lib).

---

<a id="vet-043"></a>
## VET-043 — const в protocol_pdf_service, лишний import

**Статус:** исправлен  
**Модуль:** pdf/services/protocol_pdf_service.dart

In constant expressions operands must be bool, num, String or null (строка 79); unnecessary import dart:typed_data.

**Исправление:** Убран const у TextStyle с fontWeight (fontWeight не const); удалён import dart:typed_data (используется ByteData из flutter/services).

---

<a id="vet-044"></a>
## VET-044 — Дублирование modelVersion в on_device_recognizer.dart

**Статус:** исправлен  
**Модуль:** speech/providers/on_device_recognizer.dart

Поле modelVersion и геттер modelVersion с тем же именем; duplicate_definition.

**Исправление:** Поле переименовано в _modelVersion; геттер возвращает _modelVersion; добавлен @override.

---

<a id="vet-045"></a>
## VET-045 — Deprecated value в формах (DropdownButtonFormField и др.)

**Статус:** исправлен  
**Модуль:** references_list_page, template_form_builder

'value' is deprecated, use initialValue (Flutter 3.33+).

**Исправление:** Замена value на initialValue в соответствующих виджетах.

---

<a id="vet-046"></a>
## VET-046 — Unused import в main.dart, widget_test и MyApp

**Статус:** исправлен  
**Модуль:** main.dart, test/widget_test.dart

В main.dart не используется import app_config; в widget_test используется MyApp, в main объявлен VetAssistantApp.

**Исправление:** Удалён неиспользуемый import из main.dart; в widget_test заменён MyApp на VetAssistantApp и приведён тест в соответствие с текущим экраном (или упрощён smoke test).

---

<a id="vet-073"></a>
## VET-073 — flutter analyze: override в app_database.g.dart, OrderingTerm в template_repository_impl

**Статус:** исправлен  
**Модуль:** lib/core/database/app_database.dart, lib/features/templates/data/repositories/template_repository_impl.dart

**Описание:** После изменений VET-071 (версии шаблонов) flutter analyze выдаёт: (1) warning override_on_non_overriding_member в app_database.g.dart:1516 — поле isActive помечено @override, но в базовом классе Templates колонка была убрана; (2) error в template_repository_impl.dart:70 — OrderingTerm.expression(t.version): expression не функция и не статический член.

**Исправление:** В таблицу Templates возвращена колонка isActive (BoolColumn), чтобы сгенерированный код имел корректный override. В template_repository_impl заменён вызов OrderingTerm.expression(t.version) на OrderingTerm.asc(t.version) по аналогии с reference_repository_impl и examination_repository_impl.

---

<a id="vet-074"></a>
## VET-074 — Наименования «Ключ», «Подпись» не помещаются в полях диалога редактирования раздела

**Статус:** закрыто  
**Модуль:** lib/features/admin/presentation/pages/template_edit_page.dart  
**Исправление:** Поля «Ключ», «Подпись», «Тип» в форме редактирования раздела расположены друг под другом; поля растянуты на всю ширину; ширина диалога до 90% экрана.

**Описание:** В диалоге редактирования раздела протокола (кнопка «Редактировать» у раздела) поля ввода для ключа и подписи поля раздела имеют подписи «Ключ» и «Подпись». На малых экранах или при узком диалоге эти наименования не помещаются в отведённых полях (обрезаются или наезжают на контент).

**Где воспроизвести:** Админка → шаблон (например, кардио) → Редактирование шаблона → у любого раздела кнопка «Редактировать» → в диалоге строки полей с подписями «Ключ», «Подпись», «Тип».

**Варианты решения:** Увеличить ширину полей/диалога; вынести подписи над полями (вертикальная раскладка строки); сократить подписи до иконок или одной буквы с tooltip; использовать hintText вместо labelText с более коротким текстом.

---

<a id="vet-075"></a>
## VET-075 — При нажатии «Сохранить» в редактировании шаблона протокола не сохраняются изменения

**Статус:** закрыто  
**Модуль:** lib/features/admin/presentation/pages/template_edit_page.dart, lib/features/templates/data/repositories/template_repository_impl.dart

**Описание:** В форме редактирования шаблона протокола (админка → выбор шаблона → Редактирование шаблона) при нажатии кнопки «Сохранить» изменения не записываются в БД. В частности: не сохраняется новый порядок разделов (после использования кнопок «Поднять»/«Опустить»), не сохраняются вновь добавленные разделы (кнопка «Добавить раздел»). После закрытия страницы и повторного открытия шаблона отображаются прежние данные.

**Причины:** (1) В `saveTemplate` поиск и обновление шли по `type`; при нескольких версиях (VET-071) `getSingleOrNull()` бросал исключение. Исправлено: поиск/обновление по первичному ключу `id = type_version`; при вставке новой версии деактивация остальных по `WHERE type = ? AND id != ?`. (2) **Главная причина:** `getAll()` перед чтением из БД вызывал `loadFromAssets()`, который при наличии любой записи по типу перезаписывал её содержимым из JSON в assets — правки пользователя затирались при следующем открытии списка шаблонов или экрана, использующего `templateListProvider`. Исправлено: `loadFromAssets()` только подставляет шаблон из asset, если в БД нет ни одной версии этого типа (seed); при наличии записей по типу не трогает БД.

---

<a id="vet-076"></a>
## VET-076 — В форме редактирования шаблонов протоколов нет возможности создать новую версию протокола

**Статус:** исправлен  
**Модуль:** lib/features/admin/presentation/pages/template_edit_page.dart

**Описание:** В форме редактирования шаблона протокола (админка → шаблон → Редактирование шаблона) доступно только сохранение изменений в текущую версию. Нет кнопки или действия «Создать новую версию», чтобы сохранить текущие правки как отдельную новую версию шаблона (например, 1.0.0 → 1.0.1), не перезаписывая существующую.

**Исправление:** В AppBar страницы редактирования шаблона добавлена кнопка «Создать новую версию» (иконка add_circle_outline). По нажатию открывается диалог: поле «Новая версия» (по умолчанию предлагается следующая по семверу, например 1.0.0 → 1.0.1) и флажок «Сделать активной по умолчанию». После подтверждения текущие данные формы сохраняются как новая запись в БД (тот же тип, новая версия), при необходимости новая версия делается активной, выполняется переход на редактирование созданной версии.

---

<a id="vet-094"></a>
## VET-094 — При добавлении новой версии протокола перетирается существующая более старшая версия

**Статус:** закрыто  
**Модуль:** lib/features/admin/presentation/pages/template_edit_page.dart, lib/features/admin/presentation/pages/admin_dashboard_page.dart

**Описание:** При создании новой версии шаблона в диалоге по умолчанию подставлялась следующая версия по семверу (например, при редактировании 1.0.0 предлагалась 1.0.1). Если версия 1.0.1 уже существовала в БД, сохранение выполняло UPDATE по rowId и перезаписывало содержимое существующей 1.0.1 данными из текущей формы, в результате чего более старшая версия терялась.

**Исправление:** Перед открытием диалога запрашивается список версий типа (getVersionsByType); подставляемая по умолчанию версия вычисляется итеративно (nextVersion) до первой, отсутствующей в БД. При вводе пользователем версии, которая уже есть, сохранение блокируется с сообщением и подсказкой использовать свободную версию.

---

<a id="vet-099"></a>
## VET-099 — При изменении размера или перетаскивании раздела в визуальном редакторе не работает привязка к сетке положения и размеров

**Статус:** закрыто  
**Модуль:** lib/features/admin/presentation/widgets/print_layout_editor_page.dart

**Описание:** В визуальном редакторе печатной формы (расположение блоков на странице) при перетаскивании блока или изменении его размера (pinch или за грань) значения положения (left, top) и размера (width, height) должны привязываться к сетке с шагом 10 px. Привязка не срабатывает — блоки остаются в произвольных позициях и размерах.

**Причина:** Listener с `onPointerUp` сбрасывает `_draggingIndex`, `_resizingIndex`, `_edgeResizeIndex` до того, как GestureDetector успевает вызвать `onScaleEnd`. В `onScaleEnd` логика привязки проверяет эти индексы; к моменту вызова они уже null, поэтому привязка не выполняется.

**Исправление:** Перенос сброса индексов в `onPointerUp` и `onPointerCancel` в `WidgetsBinding.instance.addPostFrameCallback`, чтобы `onScaleEnd` GestureDetector успел выполниться первым и применить привязку к сетке.

---

<a id="vet-100"></a>
## VET-100 — Нет возможности в визуальном редакторе настраивать размер и расположение раздела «Фотографии»

**Статус:** закрыто  
**Модуль:** lib/features/admin/presentation/widgets/print_layout_editor_page.dart, lib/features/pdf/services/protocol_pdf_service.dart

**Описание:** В визуальном редакторе печатной формы (расположение блоков на странице) настраиваются: шапка протокола, анамнез и разделы из шаблона. Раздел «Фотографии» в PDF выводится с фиксированным расположением и стилем — пользователь не может задать его позицию, размер и страницу в визуальном редакторе.

**Где воспроизвести:** Админка → Редактор шаблонов → выбрать шаблон → «Настроить расположение на странице». В визуальном редакторе отображаются блоки «Шапка», «Анамнез» и разделы шаблона; блока «Фотографии» нет.

**Связанные файлы:**
- `lib/features/admin/presentation/widgets/print_layout_editor_page.dart` — типы блоков: header, anamnesis, section. Раздела «Фотографии» нет.
- `lib/features/templates/domain/entities/protocol_template.dart` — настройки печати для шапки и анамнеза. Настройки для «Фотографии» отсутствуют.
- `lib/features/pdf/services/protocol_pdf_service.dart` — вывод «Фотографии» с фиксированным стилем.

**Варианты решения:** Добавить блок «Фотографии» в визуальный редактор (аналог `ProtocolHeaderPrintSettings` / `AnamnesisPrintSettings`): модель `PhotosPrintSettings` (positionX, positionY, width, height, pageIndex), блок в `_initBlocks`, сохранение в `PrintLayoutSaveResult`, использование в `ProtocolPdfService` при генерации PDF.

**Исправление (VET-100):** Добавлена модель `PhotosPrintSettings` в `protocol_template.dart`; блок «Фотографии» в визуальном редакторе (`_BlockType.photos`, фиолетовый цвет); расширены `PrintLayoutSaveResult`, `PrintLayoutEditorPage`, `TemplateEditPage`; в `ProtocolPdfService` при наличии `photosPrintSettings` с позицией блок «Фотографии» размещается на заданной странице; при отсутствии настроек — fallback на отдельную страницу как раньше.

---

<a id="vet-105"></a>

## VET-105 — В редакторе шаблона в настройках раздела и поля нет настройки типа рамки (прямоугольная или скруглённая)

**ID артефакта:** VET-105  
**Статус:** исправлен  
**Модуль:** `lib/features/admin/presentation/pages/template_edit_page.dart` — редактор шаблона протокола

### Описание

В диалоге редактирования раздела и в настройках полей раздела отсутствует возможность выбрать тип рамки (прямоугольная или скруглённая) при включённой опции «Показывать рамку». Пользователь не может задать `borderShape` для раздела и для поля.

### Где воспроизвести

- Админка → Редактор шаблонов → выбрать шаблон → Раздел → «Редактировать» (иконка карандаша) → раскрыть «Печатная форма» → включить «Показывать рамку».
- Для поля: в том же диалоге для каждого поля — включить «Показывать рамку (печать)».

Ожидается: появление выпадающего списка «Прямоугольная» / «Скруглённая» для выбора типа рамки.  
Фактически: настройка типа рамки отсутствует или не отображается.

### Связанные файлы

- `lib/features/admin/presentation/pages/template_edit_page.dart` — `_SectionEditDialog`, блок «Печатная форма», настройки полей
- `lib/features/templates/domain/entities/protocol_template.dart` — `SectionPrintSettings.borderShape`, `FieldPrintSettings.borderShape`

### Исправление (VET-105)

Выпадающий список «Тип рамки» (Прямоугольная / Скруглённая) теперь всегда отображается рядом с чекбоксом «Показывать рамку» — и для раздела, и для каждого поля. Ранее он показывался только при включённом чекбоксе, из‑за чего настройка была незаметна или недоступна.

---

<a id="vet-106"></a>

## VET-106 — При открытии раздела на редактирование возникает ошибка layout

**ID артефакта:** VET-106  
**Статус:** исправлен  
**Модуль:** `lib/features/admin/presentation/pages/template_edit_page.dart` — редактор шаблона протокола, диалог редактирования раздела

### Описание

При нажатии на иконку редактирования раздела (карандаш) в редакторе шаблона протокола возникает исключение рендеринга:

```
'package:flutter/src/rendering/shifted_box.dart': Failed assertion: line 354 pos 12: 'child!.hasSize': is not true.
RenderBox was not laid out: RenderPhysicalShape#eead9 relayoutBoundary=up2
```

Ошибка указывает на проблему с layout: дочерний виджет не получил размер (`child!.hasSize` = false), либо `RenderBox` не был laid out. Обычно связано с неограниченными constraints (unbounded) или некорректной вложенностью виджетов в диалоге.

### Где воспроизвести

- Админка → Редактор шаблонов → выбрать шаблон → нажать иконку редактирования раздела (карандаш) у любого раздела.
- Ожидается: открытие диалога «Редактирование раздела».
- Фактически: ошибка в консоли, возможен краш или некорректное отображение диалога.

### Связанные файлы

- `lib/features/admin/presentation/pages/template_edit_page.dart` — `_SectionEditDialog`, виджеты внутри диалога (в т.ч. `DropdownButtonFormField`, `Row`, `ExpansionTile`)

### Варианты решения

1. Проверить использование `DropdownButtonFormField` с `initialValue` — возможно, требуется обёртка с заданными размерами или `IntrinsicHeight`/`IntrinsicWidth`.
2. Проверить `Row` с условными дочерними виджетами (`if (_fieldShowBorder[i])` / `if (_printShowBorder)`) — при отсутствии ограничений по шириоте `Row` может не определить размер дочернего `DropdownButtonFormField`.
3. Обернуть `DropdownButtonFormField` в `SizedBox` с заданной шириной или использовать `Flexible`/`Expanded` и т.п.

### Исправление (VET-106)

Оба `DropdownButtonFormField` (для поля и для раздела) обёрнуты в `SizedBox(width: 160)`, чтобы задать ограничение по шириоте внутри `Row`. В `Row` дочерние виджеты получают unbounded width, из‑за чего `DropdownButtonFormField` не мог определить размер и возникала ошибка `child!.hasSize`.

---

---

<a id="vet-143"></a>

## VET-143 — При первом входе: после сохранения профиля и клиник нет перехода к списку пациентов

**ID артефакта:** VET-143  
**Статус:** исправлен  
**Модуль:** `lib/features/vet_profile/` — форма настройки профиля

### Описание

При первом входе в приложение открывается форма настройки профиля и клиник. После нажатия «Сохранить» пользователь остаётся на форме — нет возможности перейти к списку пациентов и протоколов.

### Причина

После сохранения вызывался `context.pop()`, но при первом запуске пользователь попал на форму по редиректу (без истории навигации). В этом случае `pop` не ведёт на список пациентов.

### Где воспроизвести

- Первый запуск приложения → форма «Настройка профиля» → заполнить поля → нажать «Сохранить».  
- Ожидалось: переход к списку пациентов (или к выбору клиники при ≥2 клиниках).  
- Фактически: остаётся на форме.

### Исправление

В `VetProfileFormPage._save()` заменён `context.pop()` на `context.go('/patients')`. После сохранения выполняется явный переход на список пациентов. При наличии ≥2 клиник редирект в роутере отправит пользователя на экран выбора клиники.

---

<a id="vet-155"></a>

## VET-155 — После редактирования шаблона протокола изменения не видны в форме просмотра протокола

**ID артефакта:** VET-155  
**Статус:** исправлен  
**Модуль:** редактор шаблонов, форма просмотра протокола, провайдеры шаблонов

### Описание

После редактирования шаблона протокола (изменение разделов, полей, подписей, порядка) изменения не отображались в форме просмотра протокола. Не все атрибуты протокола соответствовали изменённому шаблону, значения полей отображались не всегда корректно.

### Причина

1. **Кэш провайдера:** при сохранении шаблона в админке не инвалидировался `templateForExaminationProvider`. При открытии протокола подставлялся закэшированный старый шаблон.
2. **Порядок и набор полей при просмотре:** блок «Данные осмотра» строился по итерации `extractedFields.entries` (порядок ключей в Map), а не по порядку полей в шаблоне; поля, добавленные в шаблон после создания протокола, не отображались.

### Исправление

1. **template_edit_page.dart:** при сохранении шаблона, после импорта и при создании новой версии добавлен вызов `ref.invalidate(templateForExaminationProvider)`, чтобы при следующем открытии протокола подгружался актуальный шаблон.
2. **examination_detail_page.dart:** перестроен `_buildExtractedFields`: при наличии шаблона вывод полей идёт по разделам и полям шаблона (с учётом порядка разделов, обычных полей и ячеек таблицы); отображаются все поля шаблона, значение берётся из `extractedFields` или «—». Для полей типа «Фото» (значение — список) добавлено форматирование вывода.

### Связанные файлы

- `lib/features/admin/presentation/pages/template_edit_page.dart`
- `lib/features/examinations/presentation/pages/examination_detail_page.dart`
- `lib/features/templates/presentation/providers/template_providers.dart`

---

<a id="vet-156"></a>

## VET-156 — Дублирование ключей полей в разных разделах шаблона протокола

**ID артефакта:** VET-156  
**Статус:** закрыто  
**Модуль:** редактор шаблонов, модель шаблона, репозиторий шаблонов

### Описание

При добавлении полей в разных разделах шаблона протокола не проверялась уникальность ключа поля в рамках всего шаблона. В результате в протоколе значения полей из разных разделов дублировались (одна запись в `extractedFields` на ключ). Требовалось обеспечить уникальность ключей в рамках одного шаблона и выполнить конвертацию ключей в существующих шаблонах для устранения дублирования.

### Исправление

1. **protocol_template.dart:** добавлены метод `hasDuplicateFieldKeys` и метод `ensureUniqueFieldKeys()`: при повторном вхождении ключа он переименовывается в `key_2`, `key_3` и т.д. (по порядку разделов и полей). Учитываются обычные поля разделов и ячейки таблиц с `key`.
2. **template_repository_impl.dart:** при загрузке шаблона (`getByTemplateRowId`, `getById`) при обнаружении дубликатов ключей вызывается `ensureUniqueFieldKeys()`, исправленный шаблон сохраняется в БД (миграция при первом обращении).
3. **template_edit_page.dart:** при сохранении шаблона проверка `hasDuplicateFieldKeys`; при дубликатах сохранение блокируется, показывается сообщение. В формах редактирования раздела (обычного и таблицы) передаётся множество ключей из остальных разделов (`keysUsedInOtherSections`). При сохранении раздела проверяется, что ключи не дублируются с другими разделами и внутри раздела. При добавлении поля в обычный раздел подставляется уникальный ключ по умолчанию (`field_1`, `field_2`, … с учётом уже занятых).

### Связанные файлы

- `lib/features/templates/domain/entities/protocol_template.dart`
- `lib/features/templates/data/repositories/template_repository_impl.dart`
- `lib/features/admin/presentation/pages/template_edit_page.dart`

---

<a id="vet-157"></a>

## VET-157 — В форме просмотра протокола не отображаются фотографии полей типа «Фото»

**ID артефакта:** VET-157  
**Статус:** закрыто  
**Модуль:** форма просмотра протокола (examination_detail_page)

### Описание

В форме просмотра протокола осмотра фотографии, загруженные в значения полей типа «Фото», не отображались — выводился только текст (подписи/пути через _formatFieldValue), без превью изображений.

### Исправление

В `examination_detail_page.dart` для полей с типом «Фото» (когда значение — непустой список) добавлен вывод изображений: метод `_buildPhotoFieldRow(context, label, value)` строит блок с подписью поля и горизонтальным списком карточек (как блок «Фотографии»): для каждого элемента списка {path, description} — превью `Image.file(path)` и подпись. При отсутствии файла показывается иконка `Icons.broken_image`.

### Связанные файлы

- `lib/features/examinations/presentation/pages/examination_detail_page.dart`

---

<a id="vet-160"></a>

## VET-160 — Нет возможности настроить отображение «Подписи» для полей разделов в редакторе шаблонов

**ID артефакта:** VET-160  
**Статус:** исправлен  
**Модуль:** редактор шаблонов протоколов (редактирование разделов/полей)

### Описание

В редакторе шаблонов протоколов отсутствует возможность настраивать отображение «Подписи» (наименования поля) для полей разделов — пользователь не может задать, показывать ли подпись на печатной форме, где её размещать (перед полем, над полем, в начале текста), жирным/курсивом и т.д. Ожидается наличие таких настроек (в т.ч. в связи с задачами VET-158, VET-159).

### Где воспроизвести

- Редактор шаблонов → редактирование раздела → настройки полей раздела. Проверить наличие настроек отображения подписи поля для печати.

### Исправление

- **Модель:** в `FieldPrintSettings` (protocol_template.dart) добавлены поля: `showLabel` (по умолчанию true; для типа «Фото» в UI по умолчанию false), `labelPosition` ('before' | 'above' | 'inline'), `labelBold`, `labelItalic`; сериализация в fromJson/toJson.
- **Редактор раздела:** в форме редактирования раздела (template_edit_page.dart) для каждого поля добавлены элементы: чекбокс «Отображать подпись на печати», выпадающий список «Расположение подписи на печати» (Перед полем / Над полем / В начале текста поля), чекбоксы «Жирным» и «Курсивом». При смене типа поля на «Фото» значение «Отображать подпись» автоматически сбрасывается в false.
- **PDF:** в protocol_pdf_service.dart при формировании печатной формы учитываются showLabel (если false — подпись не выводится), labelPosition (перед полем / над полем / в одной строке с значением), labelBold и labelItalic (стиль подписи). Добавлена вспомогательная функция _fieldLabelStyle.

### Связанные файлы

- `lib/features/templates/domain/entities/protocol_template.dart`
- `lib/features/admin/presentation/pages/template_edit_page.dart`
- `lib/features/pdf/services/protocol_pdf_service.dart`

---

<a id="vet-161"></a>

## VET-161 — В форме редактирования выводится дополнительный текст «(мм)» в подписи у некоторых полей

**ID артефакта:** VET-161  
**Статус:** открыт  
**Модуль:** форма редактирования протокола / форма редактирования раздела шаблона (подпись поля)

### Описание

В форме редактирования (протокола осмотра или полей раздела в редакторе шаблонов) у части полей в отображаемой подписи (label) появляется лишний текст «(мм)». Подпись должна показывать только заданное наименование поля без автоматического добавления единиц измерения в скобках.

### Где воспроизвести

- Форма добавления/редактирования протокола осмотра или форма редактирования раздела шаблона — проверить поля, у которых в подписи отображается «(мм)».

### Связанные файлы

- Формы редактирования протокола и раздела шаблона (examination_create_page, template_form_builder, template_edit_page и т.п.), места вывода подписи поля.

---

<a id="vet-165"></a>

## VET-165 — В настройках шапки протокола стиль шрифта должен применяться только к значениям; наименования — всегда жирным

**ID артефакта:** VET-165  
**Статус:** открыт  
**Модуль:** генерация PDF протокола (шапка, анамнез)

### Описание

В настройках шапки протокола задаются параметры стиля шрифта (размер, «Жирный», «Курсив»). По задумке эти настройки должны применяться **только к тексту значений** полей шапки и анамнеза. **Наименования** элементов шапки («Тип протокола», «Дата», «Пациент», «Владелец») должны выводиться **всегда жирным**, независимо от настроек.

### Где воспроизвести

- Настроить шапку протокола (размер шрифта, снять «Жирный», включить «Курсив» и т.п.) → сформировать PDF → проверить: подписи полей шапки должны быть жирными, значения и текст анамнеза — в заданном стиле.

### Связанные файлы

- `lib/features/pdf/services/protocol_pdf_service.dart` (_buildHeaderWidgets, вывод анамнеза)

---

<a id="vet-167"></a>

## VET-167 — После выхода с сохранением из «Настройки шапки протокола» сбиваются настройки расположения шапки и анамнеза в визуальном редакторе

**ID артефакта:** VET-167  
**Статус:** исправлен  
**Модуль:** редактор шаблонов протоколов, настройка шапки, визуальный редактор «Расположение на странице»

### Описание

После нажатия «Сохранить» в диалоге «Настройка шапки протокола» в визуальном редакторе «Расположение на странице» сбрасывались настройки расположения и размера блока шапки (позиция X/Y, ширина, высота, страница). Причина: диалог при сохранении создавал новый объект `ProtocolHeaderPrintSettings` только с полями стиля (размер шрифта, жирный, курсив, галочки отображения) и не копировал поля позиции/размера из текущих настроек. (Настройки анамнеза этим диалогом не изменяются; они задаются только в «Расположение на странице».)

### Где воспроизвести

- Открыть редактор шаблона → «Расположение на странице» → задать позицию/размер для шапки и анамнеза → выйти с сохранением → снова открыть «Настройка шапки протокола» → изменить что-то (например размер шрифта) → Сохранить → снова открыть «Расположение на странице»: позиции шапки (и при необходимости анамнеза) сброшены.

### Связанные файлы

- `lib/features/admin/presentation/pages/template_edit_page.dart` (_HeaderPrintSettingsDialog)
- `lib/features/templates/domain/entities/protocol_template.dart` (ProtocolHeaderPrintSettings)

### Исправление

В диалоге «Настройка шапки протокола» при нажатии «Сохранить» при формировании результата копируются поля позиции/размера из текущих настроек (`widget.initial`): `positionX`, `positionY`, `width`, `height`, `pageIndex`. Расположение шапки в визуальном редакторе «Расположение на странице» после сохранения из диалога шапки больше не сбрасывается.

---

<a id="vet-168"></a>

## VET-168 — Настройка курсива в шапке протокола, в подписях полей и в настройке раздела не работает в печатной форме

**ID артефакта:** VET-168  
**Статус:** исправлен  
**Модуль:** генерация PDF протокола (protocol_pdf_service)

### Описание

При включённой настройке «Курсив» в (1) настройках шапки протокола, (2) настройках подписи поля раздела, (3) настройках раздела (печать) — в сформированном PDF текст выводился без курсива. Причина: пакет pdf при использовании кастомного TTF не даёт курсива через `fontStyle: FontStyle.italic` (VET-162); нужен явный шрифт Roboto-Italic. В шапке и в разделах использовался только `copyWith(fontStyle: italic)`, без подстановки `_pdfFontItalic`; для подписей полей при одновременном «Жирный» и «Курсив» приоритет отдавался жирному, курсив терялся.

### Где воспроизвести

- Включить «Курсив» в настройках шапки протокола → сохранить шаблон → сформировать PDF: значения полей шапки и анамнез должны быть курсивом.
- Включить «Курсив» для подписи поля в разделе → PDF: подпись поля курсивом.
- Включить «Курсив» в настройках раздела (печать) → PDF: заголовок раздела и значения полей курсивом.

### Связанные файлы

- `lib/features/pdf/services/protocol_pdf_service.dart` (шапка, разделы, подписи полей; шрифт _pdfFontItalic)

### Исправление

- Добавлен хелпер `_withItalicFont(base, useItalic)`: при `useItalic` и загруженном `_pdfFontItalic` возвращает стиль с `font: _pdfFontItalic`, иначе fallback на `copyWith(fontStyle: italic)`.
- Шапка протокола: для стилей значений полей и заголовка шапки вместо `copyWith(fontStyle: italic)` используется `_withItalicFont(..., useItalic)`.
- Разделы (все варианты вёрстки — flow, positioned, MultiPage): для headerStyle, titleStyle, cellStyle раздела используется `_withItalicFont(..., useItalic)`.
- Подписи полей: в `_fieldLabelStyle` при одновременном «Жирный» и «Курсив» приоритет отдан курсиву (сначала проверка `labelItalic && _pdfFontItalic`, затем `labelBold`), чтобы курсив гарантированно применялся при наличии шрифта.

---

<a id="vet-169"></a>

## VET-169 — Если в шаблоне протокола нет раздела «Фотографии», при редактировании протокола всё равно можно добавить фотографии

**ID артефакта:** VET-169  
**Статус:** исправлен  
**Модуль:** форма создания/редактирования протокола осмотра (examination_create_page)

### Описание

В форме создания или редактирования протокола блок «Фотографии» (заголовок, кнопка «Добавить фото», список фото) отображался всегда, как только выбран тип протокола. Ожидание: возможность добавлять фотографии к протоколу должна быть только у шаблонов, в которых есть хотя бы один раздел вида «Фотографии» (sectionKind == sectionKindPhotos). Если в шаблоне такого раздела нет, блок «Фотографии» не должен показываться, и при сохранении протокола фотографии не должны записываться.

### Где воспроизвести

- Выбрать или создать шаблон протокола без раздела «Фотографии» → открыть создание или редактирование протокола с этим шаблоном → на форме отображается блок «Фотографии» и можно добавить фото. Ожидается: блока нет, добавить фото нельзя.

### Связанные файлы

- `lib/features/examinations/presentation/pages/examination_create_page.dart`
- `lib/features/templates/domain/entities/protocol_template.dart` (sectionKindPhotos)

### Исправление

- В `build()` добавлен просмотр шаблона: `templateAsync = ref.watch(templateByIdProvider(_selectedTemplateId!))`. Блок «Фотографии» (заголовок, кнопка «Добавить фото», список фото) выводится через `templateAsync.when(data: ...)`: показывается только если `template.sections.any((s) => s.sectionKind == sectionKindPhotos)`. При загрузке или ошибке шаблона блок скрыт.
- При сохранении протокола (`_saveExamination`) список `photos` формируется только при наличии в шаблоне раздела «Фотографии»; иначе сохраняется пустой список фотографий.

---

<a id="vet-170"></a>

## VET-170 — Поле подписи к фотографии в разделе «Фотографии» не влезает в блок с фотографией

**ID артефакта:** VET-170  
**Статус:** исправлен  
**Модуль:** форма создания/редактирования протокола осмотра, раздел «Фотографии»

### Описание

В форме создания или редактирования протокола в разделе «Фотографии» каждая фотография отображалась в блоке (карточке) фиксированного размера; внутри блока — превью фото и поле ввода подписи («Подпись»). Поле подписи не помещалось в отведённый блок: высота блока была 120 px, под превью (80 px) оставалось мало места для поля ввода, из-за чего подпись обрезалась или переполняла блок.

### Где воспроизвести

- Открыть создание или редактирование протокола с шаблоном, в котором есть раздел «Фотографии» → добавить фото → ввести или просмотреть подпись к фото. Блок с фотографией и полем подписи: подпись не влезает в блок.

### Связанные файлы

- `lib/features/examinations/presentation/pages/examination_create_page.dart` (виджет `_PhotoChip`)

### Исправление

- Увеличена высота блока фото с 120 до 132 px, высота превью — с 80 до 82 px; под поле подписи зарезервировано ~48 px (с отступами), чтобы одна строка влезала без обрезки.
- Поле подписи ограничено одной строкой (`maxLines: 1`), уменьшены отступы (`contentPadding`, `Padding`), чтобы текст помещался в блок.
- Высота горизонтального списка фото (ListView) увеличена до 132 px в соответствии с высотой карточки.

---

<a id="vet-162"></a>

## VET-162 — Настройки подписи поля «Жирным» и «Курсивом» не применяются на печатной форме

**ID артефакта:** VET-162  
**Статус:** исправлен  
**Модуль:** генерация PDF протокола (protocol_pdf_service)

### Описание

В редакторе шаблонов для полей раздела задаются настройки отображения подписи на печати: «Жирным», «Курсивом». При формировании PDF эти настройки не применялись — подписи полей выводились обычным начертанием.

### Где воспроизвести

- Задать для поля раздела в шаблоне подпись с включёнными «Жирным» и/или «Курсивом» → сохранить шаблон → сформировать PDF по протоколу с данными по этому разделу → открыть PDF: подпись поля должна быть жирной/курсивной, но отображалась обычным шрифтом.

### Исправление

- В пакете dart_pdf при использовании кастомного TTF шрифта `fontStyle: FontStyle.italic` не даёт курсива — нужен отдельный файл шрифта (Roboto-Italic). Добавлена загрузка `Roboto-Italic.ttf` (assets и по URL при отсутствии), кэш `_pdfFontItalic`.
- В `_fieldLabelStyle`: для жирного подписи явно подставляется `font: fontBold`; для курсива — `font: _pdfFontItalic` (если загружен), иначе fallback на `fontStyle: italic`. Стиль подписи строится как новый `pw.TextStyle(font: font, fontSize: fontSize, fontStyle: FontStyle.normal)`, чтобы не наследовать курсив раздела и гарантированно применять только настройки подписи поля.
- Для варианта «В начале текста поля» (inline) подпись и значение выводятся через `pw.RichText` с двумя `pw.TextSpan`: подпись со стилем labelStyle, значение — cellStyle, чтобы жирный/курсив применялись к подписи.

### Связанные файлы

- `lib/features/pdf/services/protocol_pdf_service.dart` (стиль подписи поля, шрифты)

---

*При исправлении бага обновите статус на «исправлен», укажите коммит/MR и в коммите артефакт: `fix(VET-NNN): ...`. Статус «закрыто» переводится **только вручную вами** после вашего подтверждения (пересборка, проверка); автоматически артефакты в «закрыто» не переводить.*
