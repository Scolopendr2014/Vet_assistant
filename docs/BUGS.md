# Известные баги

Список заведённых багов и их статус. ID артефактов — сквозная нумерация, реестр: [ARTIFACTS.md](ARTIFACTS.md).

**Статусы:** *открыт* — баг воспроизводится; *исправлен* — в код внесено исправление; *закрыто* — исправление подтверждено (пересборка/тесты, баг не воспроизводится).

---

<a id="vet-001"></a>

## VET-001 — В PDF не отображаются русские символы

**ID артефакта:** VET-001  
**Статус:** исправлен  
**Дата:** 2026-02-04  
**Модуль:** `lib/features/pdf/` — генерация PDF протокола

### Описание

В сгенерированных PDF-файлах протоколов русский текст не отображается (или отображается как пустые места/квадраты). Затрагиваются все русскоязычные строки: заголовки («Протокол осмотра», «Анамнез», «Данные осмотра», «Фотографии»), данные пациента, анамнез, извлечённые поля, подписи к фото, футер с нумерацией страниц.

### Причина

Пакет `pdf` (Dart) по умолчанию использует встроенные PDF-шрифты (например, Helvetica), которые не содержат глифов кириллицы. В коде добавлена загрузка шрифтов Roboto из `assets/fonts/` или по URL, но в сборке шрифты не подключаются: в каталоге `assets/fonts/` нет файлов `Roboto-Regular.ttf` и `Roboto-Bold.ttf`, а загрузка из сети может не срабатывать (нет доступа, таймаут, блокировка). В результате `_pdfFontRegular` остаётся `null` и используется шрифт по умолчанию без кириллицы.

### Где воспроизвести

- `lib/features/pdf/services/protocol_pdf_service.dart` — все вызовы `pw.Text(...)` с русским текстом.
- Действия: создать протокол с русскими данными → сформировать PDF → открыть PDF в просмотрщике.

### Варианты решения

1. **Рекомендуется:** Скачать шрифты Roboto (кириллица) и положить в проект: `Roboto-Regular.ttf` и `Roboto-Bold.ttf` в каталог `assets/fonts/`. Ссылки для скачивания — в `assets/fonts/README.md`. После добавления файлов выполнить `flutter pub get` и пересобрать приложение.
2. Убедиться, что в `pubspec.yaml` в секции `flutter.assets` перечислены эти файлы (или каталог `assets/fonts/`), чтобы они попадали в сборку.
3. Для отладки: временно не глотать исключения в `_loadPdfFonts()` (убрать пустой `catch (_)`), чтобы видеть ошибку загрузки из assets или из сети.

### Связанные файлы

- `lib/features/pdf/services/protocol_pdf_service.dart`
- `pubspec.yaml` (зависимость `pdf`, секция `assets`)
- `assets/fonts/` (должны присутствовать `Roboto-Regular.ttf`, `Roboto-Bold.ttf`)

### Исправление

Шрифты Roboto с кириллицей подключены: загрузка из `assets/fonts/Roboto-Regular.ttf` и `Roboto-Bold.ttf`, при отсутствии — подгрузка по URL (GitHub, jsDelivr) с таймаутом. Во всех `pw.TextStyle` в `ProtocolPdfService` передаётся шрифт; русский текст в PDF отображается корректно.

---

<a id="vet-037"></a>

## VET-037 — В админке по кнопке «Выход» не всегда попадаешь в список пациентов

**ID артефакта:** VET-037  
**Статус:** исправлен  
**Дата:** 2026-02-04  
**Модуль:** `lib/features/admin/` — панель администратора

### Описание

После нажатия кнопки «Выход» (иконка logout) в панели администратора пользователь не всегда попадает на экран списка пациентов. Ожидается переход на главный экран со списком пациентов; наблюдается переход на страницу входа в админку (`/admin/login`) или нестабильное поведение.

### Где воспроизвести

- `lib/features/admin/presentation/pages/admin_dashboard_page.dart` — кнопка «Выйти» в AppBar (стр. ~38–41), обработчик: `context.go('/admin/login')`.
- Действия: войти в админку → нажать «Выход» → проверить, на какой экран произошёл переход.

### Варианты решения

1. Заменить переход на маршрут списка пациентов (например, `context.go('/')` или соответствующий путь из роутера) вместо `/admin/login`, чтобы после выхода пользователь оказывался на списке пациентов.
2. Проверить конфигурацию go_router (редиректы, начальный маршрут) и убедиться, что при выходе стек навигации сбрасывается и открывается экран списка пациентов.

### Связанные файлы

- `lib/features/admin/presentation/pages/admin_dashboard_page.dart`
- Конфигурация роутера (go_router)

### Исправление

Переход при нажатии «Выход» изменён с `context.go('/admin/login')` на `context.go('/patients')` — пользователь попадает на список пациентов.

---

<a id="vet-038"></a>

## VET-038 — После добавления протокола не обновляется список протоколов у пациента на экране

**ID артефакта:** VET-038  
**Статус:** закрыто  
**Дата:** 2026-02-04  
**Модуль:** `lib/features/examinations/`, `lib/features/patients/` — создание протокола и карточка пациента

### Описание

После успешного сохранения нового протокола осмотра приложение переходит на экран карточки пациента (`/patients/{id}`), но список протоколов (история осмотров) на этом экране не обновляется — новый протокол не отображается до перезахода на экран или перезапуска приложения. Ожидается: после сохранения протокола список осмотров у пациента сразу содержит новый протокол.

### Причина

Список осмотров берётся из провайдера `examinationsByPatientProvider(patientId)` (Riverpod). После вызова `context.go('/patients/${widget.patientId}')` экран карточки пациента отображает закэшированный результат провайдера; инвалидация кэша после сохранения протокола не выполняется.

### Где воспроизвести

- Создание протокола: `lib/features/examinations/presentation/pages/examination_create_page.dart` — после `repo.save(examination)` выполняется `context.go('/patients/${widget.patientId}')` без инвалидации провайдера списка осмотров.
- Отображение списка: `lib/features/patients/presentation/pages/patient_detail_page.dart` — используется `ref.watch(examinationsByPatientProvider(patientId))`.
- Действия: открыть карточку пациента → «Новый протокол» → заполнить и сохранить → на экране карточки пациента новый протокол не появляется в списке.

### Варианты решения

1. После сохранения протокола в `examination_create_page.dart` перед переходом инвалидировать провайдер: `ref.invalidate(examinationsByPatientProvider(widget.patientId!))`, затем `context.go(...)`.
2. Использовать общий провайдер-инвалидатор (например, `examinationsInvalidatorProvider`) и вызывать его при save/delete осмотра, чтобы все экраны, зависящие от списка осмотров по пациенту, получили актуальные данные.

### Связанные файлы

- `lib/features/examinations/presentation/pages/examination_create_page.dart`
- `lib/features/patients/presentation/pages/patient_detail_page.dart`
- `lib/features/examinations/presentation/providers/examination_providers.dart` (`examinationsByPatientProvider`)

---

*При исправлении бага обновите статус на «исправлен», укажите коммит/MR и в коммите артефакт: `fix(VET-NNN): ...`. После подтверждения (пересборка, проверка) переведите статус на «закрыто».*
