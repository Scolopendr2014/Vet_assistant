# План реализации релиза 1.3 — Редактор шаблонов протоколов (VET-064)

Требование **VET-064** декомпозировано на задачи VET-065 … VET-069. Все они входят в **релиз 1.3**. С областью **VET-064** объединена ранее отдельная задача **VET-008** (редактирование шаблонов, справочники, настройки валидации).

---

## Цель релиза

Реализовать полноценный редактор шаблонов протоколов осмотра:

- управление разделами (добавление, удаление, редактирование);
- настройка типа раздела (справочник, диапазон);
- порядок разделов в протоколе;
- настройка печатной формы (вид, размер, расположение);
- визуальный редактор печатной формы.

---

## Задачи и порядок реализации

### Этап 1 — Ядро редактора разделов


| Порядок | ID          | Задача                                                                                     | Зависимости |
| ------- | ----------- | ------------------------------------------------------------------------------------------ | ----------- |
| 1       | **VET-065** | Редактор шаблонов: добавление, удаление, редактирование разделов протокола (CRUD разделов) | —           |
| 2       | **VET-066** | Редактор шаблонов: тип раздела, привязка к справочнику или диапазону значений              | VET-065     |
| 3       | **VET-067** | Редактор шаблонов: задание порядка разделов в протоколе (сортировка, расположение)         | VET-065     |


**Результат этапа 1:** в админке можно открыть шаблон, видеть список разделов, добавлять/удалять/редактировать разделы (название, тип поля), привязывать к справочнику или диапазону, менять порядок разделов (drag-and-drop или стрелки вверх/вниз).

---

### Этап 2 — Печатная форма


| Порядок | ID          | Задача                                                                                           | Зависимости |
| ------- | ----------- | ------------------------------------------------------------------------------------------------ | ----------- |
| 4       | **VET-068** | Редактор шаблонов: настройка вида, размера и расположения раздела в печатной форме (модель + UI) | VET-065     |
| 5       | **VET-069** | Визуальный редактор печатной формы протокола (превью, перетаскивание, оформление)                | VET-068     |


**Результат этапа 2:** у каждого раздела в шаблоне хранятся параметры печатной формы (позиция, размер, шрифт/стиль); есть визуальный редактор, где можно настраивать расположение и внешний вид блоков на странице PDF/печатной формы.

---

## Детализация по задачам

### VET-065 — CRUD разделов

- Экран/раздел в админке: «Редактор шаблонов» или расширение существующего редактирования шаблонов (VET-032).
- Выбор шаблона протокола (кардио, УЗИ, стомат и т.д.) → список разделов этого шаблона.
- Кнопки: «Добавить раздел», «Удалить», «Редактировать».
- Редактирование раздела: название (русское), ключ поля (id для формы/JSON), тип поля (текст, число, дата, справочник, диапазон — базовая модель для VET-066).
- Сохранение в БД (существующая модель шаблонов или расширение).

### VET-066 — Тип раздела: справочник / диапазон

- В форме редактирования раздела: выбор «значение из справочника» → выбор справочника из существующих (VET-033).
- Выбор «диапазон» → мин, макс, единица измерения (опционально).
- Валидация при заполнении протокола: подстановка списка из справочника или проверка попадания в диапазон.

### VET-067 — Порядок разделов

- В списке разделов: возможность менять порядок (drag-and-drop или кнопки «вверх»/«вниз»).
- Сохранение порядка (поле `order` / `sortOrder` в сущности раздела).
- При отображении формы протокола и при генерации PDF — вывод разделов в заданном порядке.

### VET-068 — Настройки печатной формы (модель + UI)

- Расширение модели раздела (или отдельная сущность «настройки раздела в печати»): позиция X/Y или порядок на странице, ширина, высота, шрифт, размер шрифта, жирный/курсив.
- UI в редакторе шаблона: форма с полями «позиция», «размер», «оформление» для каждого раздела.
- Сохранение в шаблоне; использование при генерации PDF (protocol_pdf_service и т.п.).

### VET-069 — Визуальный редактор печатной формы

- Экран/режим: превью печатной формы (страница PDF или её имитация).
- Блоки разделов отображаются на превью; можно перетаскивать, менять размер (ручками/ползунками).
- Изменения сохраняются в настройках разделов (связь с VET-068).
- Опционально: выбор ориентации страницы, полей, колонтитулов.

---

## Рекомендуемый порядок работ

1. **VET-065** — без него нельзя двигаться дальше.
2. **VET-066** — сразу после 065, чтобы разделы были «полноценными».
3. **VET-067** — можно параллельно с 066 или сразу после.
4. **VET-068** — модель и простой UI настроек (без визуального редактора).
5. **VET-069** — визуальный редактор поверх данных из 068.
6. **VET-071** — модель версий шаблонов (рекомендуется до или параллельно с VET-065).
7. **VET-072** — админка версий и использование активной версии при создании протокола (после VET-071).

---

## Спринты релиза 1.3

Реализация идёт по коротким спринтам. Переход к следующему спринту — только после **согласования** набора задач спринта и **подтверждения закрытия** всех задач предыдущего спринта.


| Спринт       | Задачи                      | Цель спринта                                                                                | Статус   |
| ------------ | --------------------------- | ------------------------------------------------------------------------------------------- | -------- |
| **Спринт 1** | VET-071                     | Модель версий шаблонов: несколько версий на тип, признак «активна», единственность активной | закрыт   |
| **Спринт 2** | VET-065                     | CRUD разделов протокола в редакторе шаблонов                                                | закрыт   |
| **Спринт 3** | VET-066, VET-067            | Тип раздела (справочник/диапазон) + порядок разделов                                        | закрыт   |
| **Спринт 4** | VET-072 (VET-078 … VET-093) | Админка версий шаблонов, использование активной версии при создании протокола               | закрыт   |
| **Спринт 5** | VET-068, VET-095, VET-096, VET-097, VET-098, VET-101, VET-102, VET-103, VET-115, VET-116, VET-117 | Настройка вида/размера/расположения раздела; ресайз; настройка фото; нижнее меню; autoGrow/перенос страниц | закрыт   |
| **Спринт 6** | VET-069, VET-107, VET-093, VET-124, VET-088, VET-089 | Визуальный редактор печати; рамка с иконками; экспорт/импорт шаблонов; карта регрессии; тесты экспорт/импорт | закрыт   |


**Правило:** задачи спринта согласовываются перед началом; после выполнения — закрытие задач подтверждается вами, затем переходим к следующему спринту.

Детальный план спринта 4 (порядок задач, зависимости, критерии готовности): [ПЛАН_СПРИНТА_4.md](ПЛАН_СПРИНТА_4.md).

---

## VET-070 — Версии шаблонов

Требование: поддержка разных версий шаблона одного типа; у версии — признак «активна»; активной может быть только одна версия шаблона данного типа.

### Задачи


| Порядок | ID          | Задача                                                                                                                                      | Зависимости |
| ------- | ----------- | ------------------------------------------------------------------------------------------------------------------------------------------- | ----------- |
| 1       | **VET-071** | Версии шаблонов: модель данных (несколько версий на тип шаблона, признак «активна»), гарантия единственности активной версии на тип         | —           |
| 2       | **VET-072** | Версии шаблонов: админка — список версий по типу, переключение активной версии; при создании протокола использовать активную версию шаблона | VET-071     |


### Детализация

**VET-071 — Модель данных**

- Сущность «шаблон» трактуется как версия: привязка к типу протокола (кардио, УЗИ, стомат и т.д.) + идентификатор/номер версии (или дата создания).
- Поле `isActive` (или `active`): булев признак «эта версия активна».
- Ограничение (в БД или в коде при сохранении): у одного типа протокола только одна запись с `isActive == true`. При установке активности для одной версии — снять флаг у остальных версий этого типа.
- Миграция: существующие шаблоны считать одной активной версией соответствующего типа.

**VET-072 — Админка и использование**

- В админке (редактор шаблонов): по типу протокола показывать список версий шаблона (название/идентификатор версии, признак «активна»).
- Действие «Сделать активной» для выбранной версии → обновить флаги (активна только эта версия).
- При создании нового протокола и выборе типа протокола: подставлять форму и разделы из **активной** версии шаблона этого типа.
- Опционально: создание новой версии на основе существующей (копирование шаблона с новым номером версии).

---

## Критерии готовности релиза 1.3

- Все задачи VET-065 … VET-069, VET-071, VET-072 выполнены и протестированы.
- Редактор шаблонов доступен из админки.
- Разделы можно добавлять/удалять/редактировать, задавать тип (справочник/диапазон), порядок.
- Печатная форма настраивается (вид, размер, расположение); визуальный редактор позволяет править расположение и оформление на превью.
- Существующие протоколы и генерация PDF продолжают работать; при необходимости — обратная совместимость шаблонов без расширенных настроек печати.
- Поддержка версий шаблонов: у каждого типа может быть несколько версий, активна одна; при создании протокола используется активная версия.

---

## Ссылки

- Требование: **VET-064** (включает объединённый VET-008) ([ARTIFACTS.md](ARTIFACTS.md))
- Задачи: **VET-065** … **VET-069** ([ARTIFACTS.md](ARTIFACTS.md), секция «Задачи»)
- Требование: **VET-070** (версии шаблонов) ([ARTIFACTS.md](ARTIFACTS.md))
- Задачи VET-070: **VET-071**, **VET-072** ([ARTIFACTS.md](ARTIFACTS.md), секция «Задачи»)
- Текущее редактирование шаблонов: VET-032 (название и описание в админке)

