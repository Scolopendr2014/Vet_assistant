# План спринта 4 — Админка версий шаблонов (VET-072)

**Родительская задача:** VET-072 — Версии шаблонов: админка — список версий по типу, переключение активной версии; при создании протокола использовать активную версию шаблона.

**Зависимости:** VET-071 (модель версий шаблонов) — выполнена.

**Цель спринта:** Реализовать админку версий шаблонов (список версий по типу, переключение активной), переход на загрузку шаблона по версии при создании/редактировании протокола, экспорт/импорт с учётом версий. Все изменения привязаны к артефактам VET-NNN из [ARTIFACTS.md](ARTIFACTS.md).

---

## Соответствие ID — задача

| Порядок | ID          | Задача                                                                                     | Зависимости |
| ------- | ----------- | ------------------------------------------------------------------------------------------ | ----------- |
| 1       | **VET-078** | Репозиторий: DTO TemplateVersionRow, метод getVersionRowsByType                            | —           |
| 2       | **VET-079** | Провайдеры шаблонов: templateByRowId, activeTemplateList, versionRowsByType, templateForExamination | VET-078     |
| 3       | **VET-080** | Просмотр и редактирование протокола: загрузка шаблона по версии, fallback, предупреждение в UI | VET-079     |
| 4       | **VET-081** | Админка: список версий по типу, «Сделать активной», переход по row id                      | VET-078     |
| 5       | **VET-082** | Редактор шаблона по row id (TemplateEditPage, роутер, обратная совместимость)              | VET-079, VET-081 |
| 6       | **VET-083** | ValidationSettingsPage: переход в редактор по row id активной версии                       | VET-082     |
| 7       | **VET-084** | Создание протокола: activeTemplateListProvider                                             | VET-079     |
| 8       | **VET-085** | Экспорт: рефакторинг _buildExportData, комментарий о формате templateType/templateVersion  | VET-079     |
| 9       | **VET-086** | Импорт: предупреждения в отчёте об отсутствующих версиях шаблонов (опционально)           | VET-085     |
| 10      | **VET-087** | Юнит-тесты репозитория шаблонов (getByTemplateRowId, getVersionsByType, setActiveVersion, getVersionRowsByType) | VET-078     |
| 11      | **VET-088** | Юнит-тесты импорта/экспорта (templateType, templateVersion)                                | VET-085     |
| 12      | **VET-089** | Интеграционный тест: экспорт → импорт → открытие протокола                                 | VET-085, VET-086 |
| 13      | **VET-090** | Миграции: проверка schemaVersion, актуализация документации обновления приложения        | —           |
| 14      | **VET-091** | Рефакторинг: единая загрузка шаблона для протокола, именование templateRowId vs templateType | VET-080, VET-082 |
| 15      | **VET-092** | Опционально: вывод версии шаблона в PDF протокола                                          | VET-080     |
| —       | **VET-093** | Экспорт/импорт шаблонов протоколов: экспорт из формы редактирования версии; импорт с проверкой ID+версия | VET-082     |

---

## Рекомендуемый порядок работ

**Фаза 1 — данные и провайдеры**

1. **VET-078** — DTO и метод репозитория (без него нет списка версий в UI).
2. **VET-079** — провайдеры (templateByRowId, activeTemplateList, versionRowsByType, templateForExamination).

**Фаза 2 — админка версий**

3. **VET-081** — экран списка версий по типу, кнопка «Сделать активной», переход по row id.
4. **VET-082** — редактор шаблона по row id (роутер, TemplateEditPage, обратная совместимость).
5. **VET-083** — ValidationSettingsPage: переход в редактор по row id активной версии.

**Фаза 3 — использование активной версии**

6. **VET-084** — создание протокола: activeTemplateListProvider.
7. **VET-080** — просмотр/редактирование протокола: загрузка шаблона по версии, fallback, предупреждение в UI.

**Фаза 4 — экспорт/импорт и тесты**

8. **VET-085** — рефакторинг экспорта (_buildExportData, формат templateType/templateVersion).
9. **VET-086** — опционально: предупреждения при импорте об отсутствующих версиях.
10. **VET-087** — юнит-тесты репозитория шаблонов.
11. **VET-088** — юнит-тесты импорта/экспорта (templateType, templateVersion).
12. **VET-089** — интеграционный тест: экспорт → импорт → открытие протокола.

**Фаза 5 — рефакторинг и опции**

13. **VET-090** — миграции и документация обновления приложения.
14. **VET-091** — рефакторинг: единая загрузка шаблона, именование templateRowId vs templateType.
15. **VET-092** — опционально: версия шаблона в PDF.
16. **VET-093** — экспорт/импорт шаблонов из формы редактирования версии (по возможности в этом спринте).

---

## Критерии готовности спринта 4

- В админке отображается список версий шаблона по типу протокола.
- Можно переключить активную версию («Сделать активной»).
- Редактор шаблона открывается по row id версии; из ValidationSettings — по активной версии.
- При создании протокола подставляется активная версия шаблона выбранного типа.
- При открытии существующего протокола шаблон загружается по сохранённой версии (row id), с fallback и предупреждением при отсутствии версии.
- Экспорт/импорт данных учитывают templateType и templateVersion; при необходимости — обновлена документация формата.
- Юнит- и интеграционные тесты по плану выполнены (VET-087, VET-088, VET-089).
- Миграции и документация по обновлению приложения актуализированы (VET-090).

---

## Ссылки

- Реестр артефактов: [ARTIFACTS.md](ARTIFACTS.md)
- План релиза 1.3: [ПЛАН_РЕЛИЗА_1.3.md](ПЛАН_РЕЛИЗА_1.3.md)
- VET-070 / VET-071, VET-072: [ПЛАН_РЕЛИЗА_1.3.md#vet-070--версии-шаблонов](ПЛАН_РЕЛИЗА_1.3.md#vet-070--версии-шаблонов)
